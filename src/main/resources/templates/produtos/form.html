<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout}"
>
  <head>
    <title>Cadastro de Produto</title>
  </head>
  <body>
    <div id="main-content" layout:fragment="conteudo">
      <div
        class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border-t-4 border-blue-600"
      >
        <h2
          class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2"
          th:text="${produto.id == null ? 'Novo Produto' : 'Editar Produto'}"
        ></h2>

        <script>
          let timeoutBuscaForn = null;

          // 1. Busca no servidor (Debounce)
          function buscarFornecedores(termo) {
            clearTimeout(timeoutBuscaForn);
            timeoutBuscaForn = setTimeout(() => {
              if (termo.length === 0) {
                document.getElementById("resultadoFornecedores").innerHTML = "";
                return;
              }
              // Chama o controller e injeta o HTML puro
              fetch(
                "/produtos/busca-fornecedores?termo=" +
                  encodeURIComponent(termo)
              )
                .then((resp) => resp.text())
                .then((html) => {
                  document.getElementById("resultadoFornecedores").innerHTML =
                    html;
                });
            }, 300);
          }

          // 2. Seleciona o item da lista
          window.selecionarFornecedor = function (el) {
            let id = el.getAttribute("data-id");
            let nome = el.getAttribute("data-nome");

            // Preenche o ID oculto (que vai pro banco)
            document.getElementById("fornecedorId").value = id;
            // Preenche o texto visível
            document.getElementById("fornecedorBusca").value = nome;
            // Limpa a lista
            document.getElementById("resultadoFornecedores").innerHTML = "";
            // Limpa erro visual se tiver
            document
              .getElementById("fornecedorBusca")
              .classList.remove("border-red-500", "ring-red-500");
          };
        </script>

        <form
          hx-post="/produtos/salvar"
          hx-target="#main-content"
          hx-select="#main-content"
          hx-swap="outerHTML"
          hx-disabled-elt="button[type='submit']"
          th:object="${produto}"
          class="space-y-4"
        >
          <div
            th:if="${#fields.hasGlobalErrors()}"
            class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
          >
            <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
          </div>

          <input type="hidden" th:field="*{id}" />

          <div>
            <label class="block text-sm font-bold text-gray-700"
              >Nome do Produto</label
            >
            <input
              type="text"
              th:field="*{nome}"
              th:classappend="${#fields.hasErrors('nome')} ? 'border-red-500 ring-red-500' : 'border-gray-300'"
              class="mt-1 block w-full rounded shadow-sm p-2 border focus:ring-blue-500"
              placeholder="Ex: Teclado Mecânico"
            />
            <p
              th:if="${#fields.hasErrors('nome')}"
              th:errors="*{nome}"
              class="text-red-500 text-xs italic mt-1"
            ></p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-gray-700"
                >Preço (R$)</label
              >
              <input
                type="text"
                th:field="*{preco}"
                th:classappend="${#fields.hasErrors('preco')} ? 'border-red-500 ring-red-500' : 'border-gray-300'"
                class="mask-money mt-1 block w-full rounded shadow-sm p-2 border focus:ring-blue-500"
                placeholder="0.00"
              />
              <p
                th:if="${#fields.hasErrors('preco')}"
                th:errors="*{preco}"
                class="text-red-500 text-xs italic mt-1"
              ></p>
            </div>

            <div class="relative">
              <label class="block text-sm font-bold text-gray-700"
                >Fornecedor</label
              >

              <input type="hidden" th:field="*{fornecedor}" id="fornecedorId" />

              <input
                type="text"
                id="fornecedorBusca"
                class="mt-1 block w-full rounded shadow-sm p-2 border focus:ring-blue-500 outline-none"
                th:classappend="${#fields.hasErrors('fornecedor')} ? 'border-red-500 ring-red-500' : 'border-gray-300'"
                placeholder="Digite para buscar..."
                th:value="${produto.fornecedor?.nome}"
                onkeyup="buscarFornecedores(this.value)"
                onkeydown="if(event.key === 'Enter') event.preventDefault();"
                autocomplete="off"
                required
              />
              <div
                id="resultadoFornecedores"
                class="absolute z-50 w-full top-full left-0"
              ></div>

              <p
                th:if="${#fields.hasErrors('fornecedor')}"
                class="text-red-500 text-xs italic mt-1"
              >
                Selecione um fornecedor válido.
              </p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700"
              >Descrição</label
            >
            <textarea
              th:field="*{descricao}"
              rows="3"
              class="mt-1 block w-full rounded border-gray-300 shadow-sm p-2 border focus:ring-blue-500"
              placeholder="Detalhes técnicos do produto..."
            ></textarea>
          </div>

          <div
            class="pt-6 border-t border-gray-100 mt-6 flex items-center justify-end gap-3"
          >
            <a
              href="/produtos"
              hx-target="#main-content"
              hx-select="#main-content"
              hx-swap="outerHTML"
              class="px-5 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition cursor-pointer"
            >
              Cancelar
            </a>

            <button
              type="submit"
              class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow transition font-bold"
            >
              Salvar Produto
            </button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
