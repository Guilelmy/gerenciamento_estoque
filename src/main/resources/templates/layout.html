<!DOCTYPE html>
<html lang="pt-br" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGE - Sistema de Gestão de Estoque</title>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-request.htmx-indicator { opacity: 1; }
        
        /* Classe para mostrar o dropdown */
        .dropdown:hover .dropdown-menu { display: block; }
    </style>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal flex flex-col min-h-screen" hx-boost="true">

    <nav class="bg-slate-800 p-4 text-white shadow-lg z-50">
        <div class="container mx-auto flex justify-between items-center">
            
            <a href="/" class="text-xl font-bold flex items-center gap-2 hover:text-blue-300 transition"
               hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
               </svg>
               SGE
            </a>
            
            <div class="hidden md:flex space-x-6 items-center">
                 
                <a href="/" 
                   hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML"
                   class="hover:text-blue-300 transition" 
                   th:classappend="${currentPage == 'dashboard'} ? 'text-blue-400 font-bold border-b-2 border-blue-400 pb-1' : ''">
                   Dashboard
                </a>
                
                <a href="/fornecedores" 
                   hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML"
                   class="hover:text-blue-300 transition"
                   th:classappend="${currentPage == 'fornecedores'} ? 'text-blue-400 font-bold border-b-2 border-blue-400 pb-1' : ''">
                   Fornecedores
                </a>
                
                <a href="/produtos" 
                   hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML"
                   class="hover:text-blue-300 transition"
                   th:classappend="${currentPage == 'produtos'} ? 'text-blue-400 font-bold border-b-2 border-blue-400 pb-1' : ''">
                   Produtos
                </a>
                
                <a href="/estoque" 
                   hx-target="#main-content" hx-select="#main-content" hx-swap="outerHTML"
                   class="hover:text-blue-300 transition"
                   th:classappend="${currentPage == 'estoque'} ? 'text-blue-400 font-bold border-b-2 border-blue-400 pb-1' : ''">
                   Estoque
                </a>

                <div class="relative group dropdown cursor-pointer">
                    <span class="hover:text-blue-300 transition flex items-center gap-1">
                        Relatórios
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </span>
                    <div class="dropdown-menu absolute hidden text-gray-700 pt-2 w-48 -left-4 z-50">
                        <div class="bg-white rounded shadow-lg border border-gray-100 overflow-hidden">
                            <a href="/relatorios/geral" target="_blank" hx-boost="false"
                               class="block px-4 py-2 hover:bg-gray-100 border-b border-gray-100">
                               Geral de Estoque
                            </a>
                            <a href="/relatorios/por-fornecedor" target="_blank" hx-boost="false"
                               class="block px-4 py-2 hover:bg-gray-100">
                               Por Fornecedor
                            </a>
                        </div>
                    </div>
                </div>

            </div>

            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-300 hidden sm:inline" sec:authorize="isAuthenticated()">
                    Olá, <span class="font-bold text-white" sec:authentication="principal.empresa.nome">Empresa</span>
                </span>
                
                <form th:action="@{/logout}" method="post" class="inline" hx-disable>
                    <button type="submit" 
                            class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition text-white font-bold" 
                            >
                       Sair
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <div id="alert-container" class="fixed top-20 right-5 z-50 w-full max-w-sm flex flex-col gap-2 pointer-events-none"></div>

    <main class="container mx-auto flex-grow p-6">
        <div id="main-content" layout:fragment="conteudo">
            </div>
    </main>

    <footer class="bg-slate-900 text-gray-400 py-6 mt-auto">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; 2025 Sistema de Gestão de Estoque</p>
        </div>
    </footer>

    <script>
        document.body.addEventListener('htmx:configRequest', (evt) => {
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            
            if (csrfHeader && csrfToken) {
                evt.detail.headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content');
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            aplicarMascaras();
            document.body.addEventListener('htmx:afterSwap', function(evt) { aplicarMascaras(); });
        });

        function aplicarMascaras() {
            const cnpjs = document.querySelectorAll('.mask-cnpj');
            cnpjs.forEach(input => {
                input.addEventListener('input', function(e) {
                    let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,3})(\d{0,3})(\d{0,4})(\d{0,2})/);
                    e.target.value = !x[2] ? x[1] : x[1] + '.' + x[2] + '.' + x[3] + '/' + x[4] + (x[5] ? '-' + x[5] : '');
                });
            });
            const phones = document.querySelectorAll('.mask-phone');
            phones.forEach(input => {
                input.addEventListener('input', function(e) {
                    let v = e.target.value.replace(/\D/g,"");
                    v = v.replace(/^(\d{2})(\d)/g,"($1) $2"); 
                    v = v.replace(/(\d)(\d{4})$/,"$1-$2"); 
                    e.target.value = v;
                });
            });
            const moneys = document.querySelectorAll('.mask-money');
            moneys.forEach(input => {
                // Se usar input type="text" para dinheiro, implemente aqui
            });
        }

        // TOASTS
        if (!window.toastListenerAdded) {
            document.body.addEventListener("mostrarMensagem", function(evt){
                const tipo = evt.detail.tipo;
                const texto = evt.detail.mensagem;
                let corBg = tipo === 'erro' ? 'bg-red-500' : 'bg-green-500';
                let icone = tipo === 'erro' ? '❌' : '✅';

                const toast = document.createElement("div");
                toast.className = `${corBg} text-white px-6 py-4 rounded shadow-lg flex items-center gap-3 transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto border-l-4 border-white/30`;
                toast.innerHTML = `<span class="text-lg font-bold">${icone}</span><p class="font-bold text-sm">${texto}</p>`;

                const container = document.getElementById("alert-container");
                container.appendChild(toast);

                requestAnimationFrame(() => { toast.classList.remove("translate-x-full", "opacity-0"); });
                setTimeout(() => {
                    toast.classList.add("translate-x-full", "opacity-0");
                    setTimeout(() => { toast.remove(); }, 300);
                }, 4000);
            });
            window.toastListenerAdded = true; 
        }
    </script>
</body>
</html>